<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HST Braking Challenge – Carnoustie → Arbroath</title>

<style>
  body {
    background:#111;
    color:#fff;
    font-family:sans-serif;
    text-align:center;
    margin:0;
    padding:0;
  }
  h1 {
    font-size:22px;
    margin:12px 5px 4px;
  }
  p {
    margin:0 8px 8px;
    font-size:14px;
  }

  canvas {
    background:#1a1d24;
    margin-top:8px;
    border:2px solid #555;
    display:block;
    margin-left:auto;
    margin-right:auto;
    max-width:100%;
    height:auto;
    touch-action:none;
  }

  #hud {
    font-size:16px;
    margin:6px;
    min-height:3em;
  }
  #message {
    font-size:18px;
    margin-top:4px;
    min-height:1.5em;
  }

  #endScreen {
    display:none;
    text-align:center;
    padding:20px;
  }
  #endScreen button {
    padding:10px 20px;
    font-size:18px;
    border-radius:6px;
    border:1px solid #555;
    background:#222;
    color:#fff;
    cursor:pointer;
  }

  #controls {
    position:sticky;
    bottom:0;
    background:#111;
    padding:6px 4px 12px;
    border-top:1px solid #333;
    display:flex;
    justify-content:center;
    gap:6px;
    flex-wrap:wrap;
  }
  #controls button {
    flex:1 1 40%;
    max-width:140px;
    padding:10px 8px;
    margin:2px;
    border-radius:6px;
    border:1px solid #555;
    background:#222;
    color:#fff;
    font-size:14px;
    cursor:pointer;
  }
  #controls button:active {
    background:#444;
  }
  #controls button.emergency { border-color:#a00; }
  #controls button.newrun   { border-color:#0a0; }
</style>

<!-- Firebase compat scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>
<h1>HST Braking Challenge</h1>
<p>Carnoustie → Arbroath (two-stage run)</p>

<div id="hud"></div>
<div id="message"></div>

<canvas id="c" width="1000" height="260"></canvas>

<div id="endScreen">
  <h2>Final Results</h2>
  <div id="scoreSummary"></div>
  <br>
  <button onclick="restartGame()">Play Again</button>

  <hr style="margin:20px 0; border-color:#333;">

  <h3>Global Leaderboard</h3>
  <p style="font-size:13px; color:#bbb;">Top scores from everyone:</p>
  <ol id="leaderboard" style="text-align:left; max-width:260px; margin:0 auto; padding-left:20px;"></ol>
</div>

<div id="controls">
  <button onclick="setBrakeCmd(brakeCmd - 1)">Release (R)</button>
  <button onclick="setBrakeCmd(brakeCmd + 1)">Apply (A)</button>
  <button class="emergency" onclick="setBrakeCmd(6)">Emergency (E)</button>
  <button class="newrun" onclick="restartLevel()">Restart (N)</button>
</div>

<script>
// ===========================================================
// FIREBASE SETUP (using your config)
// ===========================================================
const firebaseConfig = {
  apiKey: "AIzaSyB_v2KbgDR-c9MZcZ3hZjvu08NiaFX-aTU",
  authDomain: "hst-braking-game.firebaseapp.com",
  projectId: "hst-braking-game",
  storageBucket: "hst-braking-game.firebasestorage.app",
  messagingSenderId: "934343064552",
  appId: "1:934343064552:web:8b7525a447dd163ca0825d",
  measurementId: "G-HF47P8L3SK"
};

// Initialize Firebase (compat style)
firebase.initializeApp(firebaseConfig);

// Get Firestore and reference to "scores" collection
const db = firebase.firestore();
const scoresCollection = db.collection("scores");

// ===========================================================
// CONSTANTS
// ===========================================================
const c = document.getElementById("c");
const x = c.getContext("2d");

const MPH_TO_MS = 0.44704;
const YARD_TO_M = 0.9144;

const INITIAL_CARNOUSTIE_SPEED = 100;
const INITIAL_ARBROATH_SPEED   = 65;

const INITIAL_DIST_YARDS = 2200;
const START_DIST_M       = INITIAL_DIST_YARDS * YARD_TO_M;

const TRAIN_CARS   = 6;
const CAR_LENGTH_M = 23;
const TRAIN_LENGTH_M = TRAIN_CARS * CAR_LENGTH_M;

const CAR_PIXEL   = 48;
const TRAIN_PIXEL = TRAIN_CARS * CAR_PIXEL;

const APPLY_DELAY_SERVICE = 1.5;
const RELEASE_DELAY_HIGH  = 10;
const RELEASE_DELAY_LOW   = 2;
const TIME_SCALE          = 3.0;

const PERFECT_YARDS    = 10;
const ACCEPTABLE_YARDS = 20;
const CLOSE_YARDS      = 50;

// TWEAK: make overspeed less punishing / easier to avoid at Arbroath
const OVERSPEED_THRESHOLD_MPH = 45; // was 30

// Arbroath platform behaviour
const ARBROATH_PLATFORM_FACTOR   = 1.5; // Arbroath platform 1.5× train length
const ARBROATH_STOP_FRACTION     = 0.8; // stop marker at 4/5ths of platform

// ===========================================================
// STATE
// ===========================================================
let currentLevel = "carnoustie";

let speed;
let dist;
let brakeCmd;
let brakeAct;
let brakeTimer;
let usedEmergency;
let gameOver;
let prevDist;
let lastTime = 0;

let brakeInputCount = 0;
let overspeedFlag = false;

let scoreCarnoustie = null;
let scoreArbroath   = null;

// ===========================================================
// INITIALISATION
// ===========================================================
function resetRunCommon() {
  dist            = START_DIST_M;
  brakeCmd        = 0;
  brakeAct        = 0;
  brakeTimer      = 0;
  usedEmergency   = false;
  gameOver        = false;
  overspeedFlag   = false;
  brakeInputCount = 0;

  prevDist = dist;
  const m = document.getElementById("message");
  m.textContent = "";
  m.style.color = "#fff";
}

function loadCarnoustie() {
  currentLevel = "carnoustie";
  resetRunCommon();
  speed = INITIAL_CARNOUSTIE_SPEED * MPH_TO_MS;
}

function loadArbroath() {
  currentLevel = "arbroath";
  resetRunCommon();
  speed = INITIAL_ARBROATH_SPEED * MPH_TO_MS;
}

function restartLevel() {
  if (currentLevel === "carnoustie") loadCarnoustie();
  else loadArbroath();
}

function restartGame() {
  scoreCarnoustie = null;
  scoreArbroath   = null;
  document.getElementById("endScreen").style.display = "none";
  document.getElementById("controls").style.display = "flex";
  loadCarnoustie();
}

loadCarnoustie();

// ===========================================================
// CONTROLS
// ===========================================================
function setBrakeCmd(newCmd) {
  if (gameOver || currentLevel === "complete") return;
  newCmd = Math.max(0, Math.min(6, newCmd));
  if (newCmd !== brakeCmd) brakeInputCount++;
  brakeCmd = newCmd;
}

document.addEventListener("keydown", (e) => {
  if (currentLevel === "complete") return;
  const k = e.key.toLowerCase();
  if (k === "a") setBrakeCmd(brakeCmd + 1);
  if (k === "r") setBrakeCmd(brakeCmd - 1);
  if (k === "e") setBrakeCmd(6);
  if (k === "n") restartLevel();
});

// ===========================================================
// PHYSICS
// ===========================================================
function updatePhysics(dt, realDt) {

  if (brakeCmd === 6 && brakeAct !== 6) {
    brakeAct = 6;
    brakeTimer = 0;
  } else if (brakeAct !== brakeCmd) {
    brakeTimer += realDt;

    if (brakeCmd > brakeAct) {
      if (brakeTimer >= APPLY_DELAY_SERVICE) {
        brakeAct++;
        brakeTimer = 0;
      }
    } else {
      const delay = brakeAct > 3 ? RELEASE_DELAY_HIGH : RELEASE_DELAY_LOW;
      if (brakeTimer >= delay) {
        brakeAct--;
        brakeTimer = 0;
      }
    }
  }

  let a = 0;

  if (brakeAct > 0 && brakeAct < 6) {
    if (brakeAct === 1) a = -0.12;
    else if (brakeAct === 2) a = -0.32;
    else {
      a = -0.30 * brakeAct * (1 + 0.3 * brakeAct);
    }
  } else if (brakeAct === 6) {
    a = -4.0;
    usedEmergency = true;
  }

  if (brakeAct === 0 && speed > 0.1) a -= 0.01;

  speed += a * dt;
  if (speed < 0) speed = 0;

  dist -= speed * dt;
}

// ===========================================================
// LEADERBOARD: LOAD (top 10, skip bad data)
// ===========================================================
async function loadLeaderboard() {
  const list = document.getElementById("leaderboard");
  list.innerHTML = "<li>Loading…</li>";

  try {
    const snapshot = await scoresCollection
      .orderBy("total", "desc")
      .limit(10)
      .get();

    list.innerHTML = "";

    if (snapshot.empty) {
      list.innerHTML = "<li>No scores yet – be the first!</li>";
      return;
    }

    let rank = 0;

    snapshot.forEach((doc) => {
      const data = doc.data();

      const name    = data.name || "Anonymous";
      const total   = Number(data.total);
      const cScore  = Number(data.carnoustie);
      const aScore  = Number(data.arbroath);

      if (!Number.isFinite(total)) {
        console.warn("Skipping invalid leaderboard entry:", data);
        return;
      }

      rank += 1;

      const cText = Number.isFinite(cScore) ? cScore : "?";
      const aText = Number.isFinite(aScore) ? aScore : "?";

      const li = document.createElement("li");
      li.textContent = `${rank}. ${name} – ${total} (C: ${cText}, A: ${aText})`;
      list.appendChild(li);
    });

    if (rank === 0) {
      list.innerHTML = "<li>No valid scores yet – be the first!</li>";
    }

  } catch (err) {
    console.error("Error loading leaderboard:", err);
    list.innerHTML = "<li>Could not load leaderboard.</li>";
  }
}

// ===========================================================
// LEADERBOARD: ONLY SAVE IF TOP 10
// ===========================================================
async function saveScoreIfTop10(name, total, sc, sa) {
  try {
    total = Number(total);
    sc    = Number(sc);
    sa    = Number(sa);

    if (!Number.isFinite(total)) {
      console.log("Total score is not a valid number, not saving.");
      return false;
    }

    const snapshot = await scoresCollection
      .orderBy("total", "desc")
      .limit(10)
      .get();

    let qualifies = false;

    if (snapshot.empty) {
      qualifies = true;
    } else if (snapshot.size < 10) {
      qualifies = true;
    } else {
      const lastDoc   = snapshot.docs[snapshot.docs.length - 1];
      const lastScore = Number(lastDoc.data().total);

      if (!Number.isFinite(lastScore) || total > lastScore) {
        qualifies = true;
      }
    }

    if (!qualifies) return false;

    await scoresCollection.add({
      name: name || "Anonymous",
      total: total,
      carnoustie: sc,
      arbroath: sa,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    return true;
  } catch (err) {
    console.error("Error saving top-10 score:", err);
    return false;
  }
}

// ===========================================================
// OVERSPEED TRIGGER AT PLATFORM START (ARBROATH ONLY)
// ===========================================================
function checkOverspeed() {
  if (currentLevel !== "arbroath") return;

  const endX = c.width - 60;

  const platformLength = TRAIN_PIXEL * ARBROATH_PLATFORM_FACTOR;
  const startX = endX - platformLength;
  const stopX  = startX + platformLength * ARBROATH_STOP_FRACTION;

  const noseOrigin = 60 + 40;
  const ppm = (stopX - noseOrigin) / START_DIST_M;

  const boardDistM = (stopX - startX) / ppm;

  if (!overspeedFlag &&
      prevDist > boardDistM &&
      dist     <= boardDistM) {

    const mph = speed * 2.23694;
    if (mph >= OVERSPEED_THRESHOLD_MPH) {
      overspeedFlag = true;
      const m = document.getElementById("message");
      m.style.color = "#ff8800";
      m.textContent = "Overspeed!";
    }
  }
}

// ===========================================================
// DRAWING
// ===========================================================
function drawTracks(trackY) {
  x.fillStyle = "#808080";
  x.fillRect(0, trackY - 20, c.width, 40);

  x.fillStyle = "#4c4c4c";
  for (let p = -20; p < c.width + 20; p += 28) {
    x.fillRect(p, trackY - 8, 22, 16);
  }

  x.fillStyle = "#e0e0e0";
  x.fillRect(0, trackY - 18, c.width, 3);
  x.fillRect(0, trackY + 15, c.width, 3);
}

function drawStation(trackY, startX, endX) {
  const platformH = 60;
  const bottom = trackY - 28;
  const top = bottom - platformH;

  x.fillStyle = "#d0d3dc";
  x.fillRect(startX, top, endX - startX, platformH);

  x.fillStyle = "#f9e547";
  x.fillRect(startX, bottom - 4, endX - startX, 3);

  const name = currentLevel === "arbroath" ? "Arbroath" : "Carnoustie";

  x.fillStyle = "#1f2a38";
  const w = 140, h = 26;
  const sx = (startX + endX - w) / 2;
  const sy = top - 30;
  x.fillRect(sx, sy, w, h);

  x.strokeStyle = "#fff";
  x.strokeRect(sx + 1, sy + 1, w - 2, h - 2);

  x.fillStyle = "#fff";
  x.font = "14px sans-serif";
  x.textAlign = "center";
  x.textBaseline = "middle";
  x.fillText(name, sx + w / 2, sy + h / 2);

  x.textAlign = "left";
  x.textBaseline = "alphabetic";
}

function drawTrain(trackY, stopX) {
  const noseBase = 60 + 40;
  const ppm = (stopX - noseBase) / START_DIST_M;

  let noseX = dist >= 0
    ? Math.max(stopX - dist * ppm, noseBase)
    : stopX + (-dist) * ppm;

  const y = trackY - 52;
  const h = 40;

  for (let i = 0; i < TRAIN_CARS; i++) {
    const fx = noseX - CAR_PIXEL * i;
    const rx = fx - CAR_PIXEL;

    const isFront = (i === 0);
    const isRear  = (i === TRAIN_CARS - 1);

    const body = (isFront || isRear) ? "#777" : "#aaa";
    x.fillStyle = body;
    x.fillRect(rx, y, CAR_PIXEL, h);

    x.fillStyle = "#555";
    x.fillRect(rx, y - 4, CAR_PIXEL, 6);

    x.fillStyle = "#cfd8ff";
    x.fillRect(rx + 6, y + 10, CAR_PIXEL - 12, 14);

    if (isFront) {
      x.fillStyle = body;
      x.beginPath();
      x.moveTo(fx, y);
      x.lineTo(fx + 10, y + h / 2);
      x.lineTo(fx, y + h);
      x.closePath();
      x.fill();
    }
    if (isRear) {
      x.fillStyle = body;
      x.beginPath();
      x.moveTo(rx, y);
      x.lineTo(rx - 10, y + h / 2);
      x.lineTo(rx, y + h);
      x.closePath();
      x.fill();
    }
  }
}

function drawSpeedBoard20(trackY, startX) {
  const y = trackY - 60;

  x.beginPath();
  x.strokeStyle = "#ff0000";
  x.lineWidth = 4;
  x.arc(startX, y, 20, 0, Math.PI * 2);
  x.stroke();

  x.beginPath();
  x.fillStyle = "#ffffff";
  x.arc(startX, y, 16, 0, Math.PI * 2);
  x.fill();

  x.fillStyle = "#000";
  x.font = "16px sans-serif";
  x.textAlign = "center";
  x.textBaseline = "middle";
  x.fillText("20", startX, y);
}

// ===========================================================
// HUD & SCORING
// ===========================================================
function updateHUD() {
  if (currentLevel === "complete") return;

  const yds = dist / YARD_TO_M;
  const dTxt = yds >= 0
    ? `${yds.toFixed(0)} yards to stop marker`
    : `${Math.abs(yds).toFixed(1)} yards past stop marker`;

  const brakeLabel =
      brakeCmd === 0 ? "Run" :
      brakeCmd === 1 ? "Initial" :
      brakeCmd === 6 ? "Emergency" :
      brakeCmd;

  document.getElementById("hud").innerHTML =
    `Level: ${currentLevel}<br>
     Speed: ${(speed * 2.23694).toFixed(1)} mph<br>
     ${dTxt}<br>
     Brake controller: ${brakeLabel} |
     Bogie pressure: ${brakeAct}`;
}

function calculateScore(yardsError, finalBrakeAct) {
  let score = 100;
  const abs = Math.abs(yardsError);

  let perYard = 1.2;
  let maxDistPenalty = 60;

  // TWEAK: Arbroath much more forgiving so nailed stops can be 95+
  if (currentLevel === "arbroath") {
    perYard = 0.5;        // was 0.8
    maxDistPenalty = 25;  // was 40
  }

  score -= Math.min(abs * perYard, maxDistPenalty);

  const extraInputs = Math.max(0, brakeInputCount - 3);
  score -= extraInputs * 5;

  const pressurePenalty = Math.max(0, finalBrakeAct - 1) * 3;
  score -= pressurePenalty;

  if (usedEmergency) score -= 15;

  // TWEAK: Overspeed penalty reduced
  if (currentLevel === "arbroath" && overspeedFlag) score -= 10; // was 25

  return Math.max(0, Math.min(100, Math.round(score)));
}

function checkStop() {
  if (speed > 0.1) return false;

  const yds = dist / YARD_TO_M;
  const abs = Math.abs(yds);
  const dir = yds > 0 ? "short" : "over";

  const score = calculateScore(yds, brakeAct);
  const msgEl = document.getElementById("message");

  if (currentLevel === "carnoustie") scoreCarnoustie = score;
  if (currentLevel === "arbroath")   scoreArbroath   = score;

  let perfect    = PERFECT_YARDS;
  let acceptable = ACCEPTABLE_YARDS;
  let close      = CLOSE_YARDS;

  if (currentLevel === "arbroath") {
    perfect    = 15;
    acceptable = 30;
    close      = 70;
  }

  let msg;
  if (abs <= 1) {
    msgEl.style.color = "#00ffcc";
    msg = `Wow are you Paul Diack? – ${abs.toFixed(2)} yards ${dir}. Score: ${score}`;
  } else if (abs <= perfect) {
    msgEl.style.color = "#00ff66";
    msg = `Perfect stop – ${abs.toFixed(2)} yards ${dir}. Score: ${score}`;
  } else if (abs <= acceptable) {
    msgEl.style.color = "#99ff33";
    msg = `Acceptable stop – ${abs.toFixed(2)} yards ${dir}. Score: ${score}`;
  } else if (abs <= close) {
    msgEl.style.color = "#ffcc00";
    msg = `Oooooft that was close! – ${abs.toFixed(2)} yards ${dir}. Score: ${score}`;
  } else {
    msgEl.style.color = "#ff4444";
    msg = `${abs.toFixed(2)} yards ${dir}. Score: ${score}`;
  }

  msgEl.textContent = msg;
  return true;
}

// ===========================================================
// LEVEL TRANSITIONS
// ===========================================================
function endCarnoustie() {
  const m = document.getElementById("message");
  m.style.color = "#66ccff";
  m.textContent += " | Next stop: Arbroath…";
  setTimeout(loadArbroath, 2500);
}

function endArbroath() {
  currentLevel = "complete";

  const total = scoreCarnoustie + scoreArbroath;
  const avg   = Math.round(total / 2);

  let grade =
      avg >= 90 ? "Gold Driver" :
      avg >= 70 ? "Competent" :
      avg >= 50 ? "Needs Practice" :
                  "DTM wants a word";

  let nickname = prompt("Enter your driver nickname for the leaderboard:", "");
  if (nickname) nickname = nickname.trim();
  if (!nickname) nickname = "Anonymous";

  const summary =
    `Carnoustie: ${scoreCarnoustie}<br>
     Arbroath: ${scoreArbroath}<br><br>
     <b>Total: ${total}</b><br>
     Average: ${avg}<br>
     Grade: <b>${grade}</b><br><br>
     Name on leaderboard: <b>${nickname}</b>`;

  document.getElementById("scoreSummary").innerHTML = summary;
  document.getElementById("endScreen").style.display = "block";
  document.getElementById("controls").style.display = "none";

  saveScoreIfTop10(nickname, total, scoreCarnoustie, scoreArbroath)
    .then((didSave) => {
      if (didSave) {
        const msgEl = document.getElementById("message");
        msgEl.style.color = "#00ffcc";
        msgEl.textContent = "NEW HIGH SCORE! You made the global top 10.";

        const summaryDiv = document.getElementById("scoreSummary");
        summaryDiv.innerHTML += `<br><br><span style="color:#00ffcc;">NEW HIGH SCORE – you made the global top 10!</span>`;
      }
      loadLeaderboard();
    })
    .catch((err) => {
      console.error("Error during save/top10 check:", err);
      loadLeaderboard();
    });
}

// ===========================================================
// MAIN LOOP & SCENE
// ===========================================================
function drawScene() {
  x.clearRect(0,0,c.width,c.height);

  const sky = x.createLinearGradient(0,0,0,c.height);
  sky.addColorStop(0,"#87ceeb");
  sky.addColorStop(0.6,"#66a6ff");
  sky.addColorStop(1,"#b3e5ff");
  x.fillStyle = sky;
  x.fillRect(0,0,c.width,c.height);

  const trackY = 185;
  const endX   = c.width - 60;

  const platformLength = TRAIN_PIXEL * (currentLevel === "arbroath" ? ARBROATH_PLATFORM_FACTOR : 1.0);
  const startX = endX - platformLength;

  const stopX =
    currentLevel === "arbroath"
      ? startX + platformLength * ARBROATH_STOP_FRACTION
      : endX;

  drawTracks(trackY);
  drawStation(trackY, startX, endX);

  x.fillStyle = "deepskyblue";
  x.fillRect(stopX - 3, trackY - 40, 6, 80);

  if (currentLevel === "arbroath") {
    drawSpeedBoard20(trackY, startX);
  }

  drawTrain(trackY, stopX);
}

function loop(ts) {
  if (!lastTime) lastTime = ts;
  const realDt = (ts - lastTime) / 1000;
  lastTime = ts;

  const dt = realDt * TIME_SCALE;

  if (!gameOver && currentLevel !== "complete") {
    updatePhysics(dt, realDt);
    checkOverspeed();

    if (speed <= 0.1) {
      checkStop();

      if (currentLevel === "carnoustie") endCarnoustie();
      else endArbroath();

      gameOver = true;
    }
  }

  drawScene();
  updateHUD();

  prevDist = dist;
  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>
</body>
</html>
